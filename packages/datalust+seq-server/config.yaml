subpackage:
  - runtime*
  - cli
name: datalust+seq-server
version: 2023.1.9162
$version: 2023.1.9162
distribution: epsitec/
maintainer:
  name: Mathieu Schroeter
  email: mathieu@schroetersa.ch
architecture:
  - source
description:
  brief: Datalust Seq server
  long: 'The self-hosted search, analysis, and alerting server built for structured logs and traces'
dependency:
  install:
    adler+zlib:
      - version: ''
        architecture:
          - linux-amd64
    openssl+openssl:
      - version: ''
        architecture: []
  build:
    xcraft+base-build:
      - version: ''
        architecture: []
    xcraft+utils-linux:
      - version: ''
        architecture:
          - linux-amd64
    debian+dpkg:
      - version: ''
        architecture:
          - linux-i386
          - linux-amd64
    debian+lintian:
      - version: ''
        architecture:
          - linux-i386
          - linux-amd64
bump: []
data:
  get:
    uri: 'https://owncloud.epsitec.ch/owncloud/index.php/s/dnyTYiNLfX63BLm/download/seq-server-2023.1.9162.tar.gz'
    mirrors: []
    ref: ''
    $ref: ''
    out: ''
    externals: true
    prepare: ''
  type: src
  configure: ''
  rules:
    type: script
    location: data/seq-server-<THIS.$VERSION>
    args:
      postinst: ''
      prerm: ''
      makeall: |-
        mv('Client', '<PEON.INSTALLDIR.CLI>/opt/seq-client');
        mv('.',      '<PEON.INSTALLDIR>/opt/seq-server');
      maketest: ''
      makeinstall: ''
    test: none
    env: {}
  deploy: |-
    const storagePath = '/var/lib/seq-server/data';

    exp('LD_LIBRARY_PATH', '{PEON.PROD.ROOTDIR}/usr/lib');
    yield exec('standalonize', `{PEON.INSTALLDIR}/opt/seq-server`);
    yield exec('standalonize', `{PEON.INSTALLDIR}/opt/seq-server/Native`);
    yield exec('standalonize', `{PEON.INSTALLDIR.CLI}/opt/seq-client`);

    /* Server */
    yield exec(
      'debify',
      'seq-server',
      '{THIS.VERSION}',
      '{THIS.DESCRIPTION.BRIEF}',
      '{THIS.DESCRIPTION.LONG}',
      '{THIS.MAINTAINER.NAME}',
      '{THIS.MAINTAINER.EMAIL}',
      '{PEON.INSTALLDIR}/opt/seq-server',
      `{PEON.INSTALLDIR}/opt/packages/deb`,
      `systemd/WorkingDirectory=/opt/seq-server`,
      `systemd/ExecStart=/opt/seq-server/Seq run --storage=${storagePath}`,
      'systemd/KillSignal=SIGINT'
    );
    rm('{PEON.INSTALLDIR}/opt/seq-server');

    /* CLI */
    yield exec(
      'debify',
      'seq-client',
      '{THIS.VERSION}',
      '{THIS.DESCRIPTION.BRIEF}',
      '{THIS.DESCRIPTION.LONG}',
      '{THIS.MAINTAINER.NAME}',
      '{THIS.MAINTAINER.EMAIL}',
      '{PEON.INSTALLDIR.CLI}/opt/seq-client',
      `{PEON.INSTALLDIR.CLI}/opt/packages/deb`
    );
    rm('{PEON.INSTALLDIR.CLI}/opt/seq-client');
  env:
    path: []
    other: {}
  embedded: true
  runtime:
    configure: ''
