name: datalust+seq-server
version: 2023.1.9162
$version: 2023.1.9162
distribution: epsitec/
maintainer:
  name: Mathieu Schroeter
  email: mathieu@schroetersa.ch
architecture:
  - linux-amd64
description:
  brief: Datalust Seq server
  long: 'The self-hosted search, analysis, and alerting server built for structured logs and traces'
dependency:
  make:
    xcraft+base-make:
      - version: ''
        architecture: []
    openssl+openssl:
      - version: ''
        architecture: []
bump: []
data:
  get:
    uri: 'https://owncloud.epsitec.ch/owncloud/index.php/s/dnyTYiNLfX63BLm/download/seq-server-2023.1.9162.tar.gz'
    mirrors: []
    ref: ''
    $ref: ''
    out: ''
    externals: true
  type: bin
  configure: |-
    const serverPath = 'opt/seq-server';
    const storagePath = '/var/lib/seq-server/data';
    const stagingPath = `{PEON.WPKG.STAG}/usr/share/datalust/seq-server/cache`;

    rm('data/seq-server-<THIS.$VERSION>/Client');
    mv('data/seq-server-<THIS.$VERSION>', `tmp/${serverPath}`);

    exp('LD_LIBRARY_PATH', '{PEON.PROD.ROOTDIR}/usr/lib');
    yield exec('standalonize', `tmp/${serverPath}`);
    yield exec('standalonize', `tmp/${serverPath}/Native`);

    yield exec(
      'debify',
      'seq-server',
      '{THIS.VERSION}',
      '{THIS.DESCRIPTION.BRIEF}',
      '{THIS.DESCRIPTION.LONG}',
      '{THIS.MAINTAINER.NAME}',
      '{THIS.MAINTAINER.EMAIL}',
      `${stagingPath}/tmp/${serverPath}`,
      `${stagingPath}/root/opt/packages/deb`,
      `systemd/WorkingDirectory=/${serverPath}`,
      `systemd/ExecStart=/${serverPath}/Seq run --storage=${storagePath}`,
      'systemd/KillSignal=SIGINT'
    );
  rules:
    type: move
    location: root
    args:
      postinst: ''
      prerm: ''
    env: {}
  env:
    path: []
    other: {}
  embedded: true
